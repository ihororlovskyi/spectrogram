<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spectrogram Maker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/src/style.css">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
</head>
<body class="bg-neutral-900 text-white">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="border-b border-gray-800 px-6 py-6">
      <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-light tracking-tight">Spectrogram Maker</h1>
          <p class="text-xs text-gray-500 mt-1 tracking-widest uppercase">Audio Visualization</p>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">
      <!-- Left Sidebar -->
      <div class="w-80 border-r border-gray-800 overflow-y-auto">
        <div class="p-6 space-y-6">
          <!-- Upload Section -->
          <div>
            <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider block mb-3">Upload</label>
            <div id="upload-zone" class="border border-dashed border-gray-700 rounded-lg p-6 text-center cursor-pointer hover:border-gray-600 transition-colors">
              <div class="text-2xl mb-2">üìÅ</div>
              <p class="text-xs text-gray-400">Click to upload or drag & drop</p>
              <input type="file" id="file-input" accept=".mp3,.wav,.flac,.ogg,.m4a,.aac,.wma" class="hidden">
            </div>
          </div>

          <!-- Selected File -->
          <div id="selected-file" class="hidden">
            <div class="bg-gray-900 rounded-lg p-3 border border-gray-800">
              <div class="flex items-start gap-2">
                <span class="text-lg">üéß</span>
                <div class="flex-1 min-w-0">
                  <p id="file-name" class="text-xs font-medium truncate"></p>
                  <p id="file-size" class="text-xs text-gray-500 mt-1"></p>
                </div>
                <button id="remove-file" class="text-gray-500 hover:text-gray-300 transition-colors">‚úï</button>
              </div>
            </div>
          </div>

          <!-- Error Message -->
          <div id="error-message" class="hidden">
            <div class="bg-red-950 border border-red-900 rounded-lg p-3 flex items-start gap-2">
              <span>‚ö†Ô∏è</span>
              <p id="error-text" class="text-xs text-red-300"></p>
            </div>
          </div>

          <!-- Settings -->
          <div class="space-y-5">
            <!-- Colormap -->
            <div>
              <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider block mb-2">Colormap</label>
              <div class="grid grid-cols-3 gap-1">
                <button class="colormap-btn py-2 px-2 bg-white text-black text-xs font-medium rounded active" data-colormap="magma">Magma</button>
                <button class="colormap-btn py-2 px-2 bg-gray-800 text-gray-300 text-xs font-medium rounded hover:bg-gray-700 transition-colors" data-colormap="viridis">Viridis</button>
                <button class="colormap-btn py-2 px-2 bg-gray-800 text-gray-300 text-xs font-medium rounded hover:bg-gray-700 transition-colors" data-colormap="plasma">Plasma</button>
                <button class="colormap-btn py-2 px-2 bg-gray-800 text-gray-300 text-xs font-medium rounded hover:bg-gray-700 transition-colors" data-colormap="inferno">Inferno</button>
                <button class="colormap-btn py-2 px-2 bg-gray-800 text-gray-300 text-xs font-medium rounded hover:bg-gray-700 transition-colors" data-colormap="cividis">Cividis</button>
                <button class="colormap-btn py-2 px-2 bg-gray-800 text-gray-300 text-xs font-medium rounded hover:bg-gray-700 transition-colors" data-colormap="gray">Gray</button>
              </div>
              <input type="hidden" id="colormap" value="magma">
            </div>

            <!-- FFT Scale -->
            <div>
              <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider block mb-2">FFT Scale</label>
              <div class="flex gap-1">
                <button class="scale-btn flex-1 py-2 px-2 bg-white text-black text-xs font-medium rounded active" data-scale="linear">Linear</button>
                <button class="scale-btn flex-1 py-2 px-2 bg-gray-800 text-gray-300 text-xs font-medium rounded hover:bg-gray-700 transition-colors" data-scale="mel">Mel</button>
                <button class="scale-btn flex-1 py-2 px-2 bg-gray-800 text-gray-300 text-xs font-medium rounded hover:bg-gray-700 transition-colors" data-scale="log">Log</button>
              </div>
              <input type="hidden" id="scale" value="linear">
            </div>

            <!-- FFT Size -->
            <div>
              <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider block mb-2">FFT Size</label>
              <div class="grid grid-cols-2 gap-1">
                <button class="fft-btn py-2 px-2 bg-gray-800 text-gray-300 text-xs font-medium rounded hover:bg-gray-700 transition-colors" data-fft="1024">1K</button>
                <button class="fft-btn py-2 px-2 bg-white text-black text-xs font-medium rounded active" data-fft="2048">2K</button>
                <button class="fft-btn py-2 px-2 bg-gray-800 text-gray-300 text-xs font-medium rounded hover:bg-gray-700 transition-colors" data-fft="4096">4K</button>
                <button class="fft-btn py-2 px-2 bg-gray-800 text-gray-300 text-xs font-medium rounded hover:bg-gray-700 transition-colors" data-fft="8192">8K</button>
              </div>
              <input type="hidden" id="fft-size" value="2048">
            </div>

            <!-- Mode -->
            <div>
              <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider block mb-2">Sharpness</label>
              <div class="flex gap-1">
                <button class="mode-btn flex-1 py-2 px-2 bg-gray-800 text-gray-300 text-xs font-medium rounded hover:bg-gray-700 transition-colors" data-mode="sharper" title="Max detail + contrast (slowest)">Sharp‚Üë‚Üë</button>
                <button class="mode-btn flex-1 py-2 px-2 bg-gray-800 text-gray-300 text-xs font-medium rounded hover:bg-gray-700 transition-colors" data-mode="sharp" title="More detail + contrast (slower)">Sharp‚Üë</button>
                <button class="mode-btn flex-1 py-2 px-2 bg-white text-black text-xs font-medium rounded active" data-mode="classic" title="Balanced, fastest">Classic</button>
              </div>
              <input type="hidden" id="mode" value="classic">
              <p class="text-[10px] text-gray-500 mt-2">Sharp modes use smaller hop length + pre-emphasis for crisper detail (slower).</p>
            </div>
          </div>

          <!-- Generate Button -->
          <button id="submit-2d-btn" disabled class="w-full bg-white text-black py-2.5 rounded font-medium text-sm uppercase tracking-wide hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
            Generate
          </button>
        </div>
      </div>

      <!-- Right Content Area -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Preview -->
        <div id="preview-container" class="hidden flex-1 flex items-center justify-center p-6 border-b border-gray-800 bg-gray-950">
          <div class="text-center">
            <p class="text-xs text-gray-500 uppercase tracking-wider mb-4">Preview</p>
            <div id="preview-loading" class="hidden flex items-center justify-center gap-3 mb-4">
              <span class="spinner"></span>
              <span class="text-xs text-gray-400">Generating...</span>
            </div>
            <img id="preview-image" src="" alt="Preview" class="max-h-96 rounded spectrogram-image">
          </div>
        </div>

        <!-- Progress -->
        <div id="progress-section" class="hidden flex-1 flex flex-col items-center justify-center p-6 bg-gray-950">
          <span class="spinner mb-4"></span>
          <p id="progress-message" class="text-sm text-gray-400 mb-6">Processing...</p>
          <div class="w-full max-w-xs">
            <div class="bg-gray-800 h-1 rounded-full overflow-hidden">
              <div id="progress-bar" class="bg-white h-full" style="width: 0%;"></div>
            </div>
            <p id="progress-percent" class="text-xs text-gray-500 text-center mt-3">0%</p>
          </div>
        </div>

        <!-- Results -->
        <div id="results-section" class="hidden flex-1 flex flex-col p-6 overflow-y-auto bg-gray-950">
          <div class="mb-6">
            <img id="preview-2d" src="" alt="Result" class="w-full rounded spectrogram-image">
          </div>
          <div>
            <h3 id="name-2d" class="text-sm font-medium mb-1 truncate">spectrogram.jpg</h3>
            <p id="meta-2d" class="text-xs text-gray-500 mb-4">-</p>
            <button id="download-2d" class="w-full bg-white text-black py-2 rounded font-medium text-sm uppercase tracking-wide hover:bg-gray-100 transition-colors">
              Download
            </button>
          </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="flex-1 flex flex-col items-center justify-center p-6 bg-gray-950">
          <p class="text-gray-500 text-sm">Upload an audio file to get started</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // DOM Elements
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('file-input');
    const selectedFile = document.getElementById('selected-file');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const removeFile = document.getElementById('remove-file');
    const submit2dBtn = document.getElementById('submit-2d-btn');
    const progressSection = document.getElementById('progress-section');
    const progressBar = document.getElementById('progress-bar');
    const progressPercent = document.getElementById('progress-percent');
    const progressMessage = document.getElementById('progress-message');
    const resultsSection = document.getElementById('results-section');
    const previewContainer = document.getElementById('preview-container');
    const previewLoading = document.getElementById('preview-loading');
    const previewImage = document.getElementById('preview-image');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const emptyState = document.getElementById('empty-state');

    const colormap = document.getElementById('colormap');
    const scale = document.getElementById('scale');
    const fftSize = document.getElementById('fft-size');
    const mode = document.getElementById('mode');

    const colormapBtns = document.querySelectorAll('.colormap-btn');
    const scaleBtns = document.querySelectorAll('.scale-btn');
    const fftBtns = document.querySelectorAll('.fft-btn');
    const modeBtns = document.querySelectorAll('.mode-btn');

    let currentFile = null;
    let currentTaskId = null;

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function handleFile(file) {
      const validTypes = ['.mp3', '.wav', '.flac', '.ogg', '.m4a', '.aac', '.wma'];
      const ext = '.' + file.name.split('.').pop().toLowerCase();

      if (!validTypes.includes(ext)) {
        showError('Unsupported format');
        return;
      }

      currentFile = file;
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      selectedFile.classList.remove('hidden');
      uploadZone.classList.add('hidden');
      submit2dBtn.disabled = false;
      hideError();
      updatePreview();
    }

    uploadZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      if (e.target.files[0]) handleFile(e.target.files[0]);
    });

    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('border-gray-500');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('border-gray-500');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('border-gray-500');
      if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
    });

    removeFile.addEventListener('click', () => {
      currentFile = null;
      selectedFile.classList.add('hidden');
      uploadZone.classList.remove('hidden');
      submit2dBtn.disabled = true;
      previewContainer.classList.add('hidden');
      resultsSection.classList.add('hidden');
      emptyState.classList.remove('hidden');
    });

    function updateButtonStyles(buttons, btn) {
      buttons.forEach(b => {
        b.classList.remove('active', 'bg-white', 'text-black');
        b.classList.add('bg-gray-800', 'text-gray-300');
      });
      btn.classList.add('active', 'bg-white', 'text-black');
      btn.classList.remove('bg-gray-800', 'text-gray-300');
    }

    colormapBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        updateButtonStyles(colormapBtns, btn);
        colormap.value = btn.dataset.colormap;
        updatePreview();
      });
    });

    scaleBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        updateButtonStyles(scaleBtns, btn);
        scale.value = btn.dataset.scale;
        updatePreview();
      });
    });

    fftBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        updateButtonStyles(fftBtns, btn);
        fftSize.value = btn.dataset.fft;
        updatePreview();
      });
    });

    modeBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        updateButtonStyles(modeBtns, btn);
        mode.value = btn.dataset.mode;
        updatePreview();
      });
    });

    function showError(message) {
      errorText.textContent = message;
      errorMessage.classList.remove('hidden');
    }

    function hideError() {
      errorMessage.classList.add('hidden');
    }

    async function updatePreview() {
      if (!currentFile) return;

      previewLoading.classList.remove('hidden');
      previewImage.src = '';
      previewImage.style.display = 'none';
      emptyState.classList.add('hidden');
      previewContainer.classList.remove('hidden');

      try {
        const formData = new FormData();
        formData.append('file', currentFile);

        // Build URL with query parameters
        const params = new URLSearchParams({
          'colormap': colormap.value,
          'scale': scale.value,
          'fft_size': fftSize.value,
          'mode': mode.value,
          'use_gpu': 'true'
        });

        const response = await fetch(`/api/preview?${params.toString()}`, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const error = await response.json();
          showError(error.detail || 'Failed');
          previewLoading.classList.add('hidden');
          return;
        }

        const data = await response.json();
        previewImage.src = data.preview_url;
        previewImage.style.display = 'block';
        previewLoading.classList.add('hidden');
        hideError();
      } catch (e) {
        showError('Error: ' + e.message);
        previewLoading.classList.add('hidden');
      }
    }

    submit2dBtn.addEventListener('click', async () => {
      if (!currentFile) return;

      try {
        const formData = new FormData();
        formData.append('file', currentFile);

        // Build URL with query parameters
        const params = new URLSearchParams({
          'colormap': colormap.value,
          'scale': scale.value,
          'fft_size': fftSize.value,
          'mode': mode.value,
          'use_gpu': 'true'
        });

        const response = await fetch(`/api/upload?${params.toString()}`, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const error = await response.json();
          showError(error.detail || 'Upload failed');
          return;
        }

        const data = await response.json();
        currentTaskId = data.task_id;
        progressSection.classList.remove('hidden');
        previewContainer.classList.add('hidden');
        resultsSection.classList.add('hidden');
        hideError();

        pollProgress();
      } catch (e) {
        showError('Error: ' + e.message);
      }
    });

    async function pollProgress() {
      try {
        const response = await fetch(`/api/task/${currentTaskId}`);
        const data = await response.json();

        progressPercent.textContent = data.progress + '%';
        progressBar.style.width = data.progress + '%';
        progressMessage.textContent = data.message;

        if (data.status === 'completed') {
          progressSection.classList.add('hidden');
          resultsSection.classList.remove('hidden');

          const result = data.result.spectrogram_2d;
          document.getElementById('preview-2d').src = result.url;
          document.getElementById('name-2d').textContent = result.filename;
          document.getElementById('meta-2d').textContent =
            `${result.duration}s ‚Ä¢ ${result.sample_rate} Hz`;

          document.getElementById('download-2d').onclick = () => {
            window.location.href = `/api/download/${result.filename}`;
          };
        } else if (data.status === 'error') {
          progressSection.classList.add('hidden');
          showError(data.message);
        } else {
          setTimeout(pollProgress, 500);
        }
      } catch (e) {
        showError('Error: ' + e.message);
      }
    }
  </script>
  <script type="module" src="/src/main.js"></script>
</body>
</html>
